<nav class="sidebar-nav"
     [class.open]="isOpen()"
     [class.closed]="!isOpen()"
     [attr.data-state]="isOpen() ? 'open' : 'closed'">

  @if (isOpen()) {
    <div class="toggle-button">
      <div class="toggle-button__container">
        <app-btn-icon
          size="medium"
          variant="transparent"
          rounded="radius-normal"
          icon="chevron_left"
          (click)="onOpenClose()"
        ></app-btn-icon>
      </div>
    </div>
  }

  <div class="sidebar-header">
    <div class="sidebar-header__logo-container">
      <img [src]="isOpen() ? 'assets/images/logo-aura-prueba.png' : 'assets/images/logo.png'"
           [alt]="isOpen() ? 'AURA' : 'logo'"
           class="sidebar-logo"/>
    </div>
  </div>

  <div class="sidebar-divider"></div>

  <div class="sidebar-body">
    <div class="toggle-button">
      <div class="toggle-button__container">
        <app-btn-icon
          size="medium"
          rounded="radius-normal"
          [icon]="isOpen() ? 'chevron_left' : 'chevron_right'"
          [attr.aria-label]="isOpen() ? 'Cerrar sidebar' : 'Abrir sidebar'"
          (click)="onOpenClose()"
        ></app-btn-icon>
      </div>
    </div>

    <div class="items-row has-icon" (click)="emitNewClick()">
      <div class="items-row__icon">
        <i class="pi pi-plus"></i>
      </div>
      @if (isOpen()) {
        <span class="items-row__text">Nuevo chat</span>
      }
    </div>

    <div class="items-row has-icon" (click)="emitNewGroupChatClick()">
      <div class="items-row__icon">
        <i class="pi pi-users"></i>
      </div>
      @if (isOpen()) {
        <span class="items-row__text">Nuevo chat grupal</span>
      }
    </div>

    <div class="items-row has-icon" [class.active]="activeId === 'search'" (click)="emitSelect('search')">
      <div class="items-row__icon">
        <i class="pi pi-search"></i>
      </div>
      @if (isOpen()) {
        <span class="items-row__text">Buscar</span>
      }
    </div>

    @if (isOpen()) {
      <div class="chats-container">
        @if (groupChats.length > 0) {
          <div class="chats-section-header">
            <div class="chats-title">Chats grupales</div>
          </div>
          <div class="chats-group">
            @for (c of groupChats; track c.id) {
              <div class="items-row chat-row" 
                   [class.active]="activeId === c.id" 
                   [attr.data-chat-id]="c.id"
                   (click)="emitSelect(c.id)"
                   (mouseenter)="onChatMouseEnter(c.id)"
                   (mouseleave)="onChatMouseLeave()">
                <i class="pi pi-users chat-type-icon"></i>
                <span class="items-row__text">{{ c.title }}</span>
                <div class="chat-options-container">
                  <button class="chat-options-btn" 
                          [class.visible]="hoveredChatId() === c.id"
                          (click)="onChatOptionsClick($event, c.id)"
                          [attr.aria-label]="'Opciones del chat ' + c.title">
                    <i class="pi pi-ellipsis-h"></i>
                  </button>
                </div>
              </div>
            }
          </div>
        }

        <div class="chats-section-header">
          <div class="chats-title">Tus chats</div>
        </div>
        <div class="chats-group">
          @for (c of individualChats; track c.id) {
            <div class="items-row chat-row" 
                 [class.active]="activeId === c.id" 
                 [attr.data-chat-id]="c.id"
                 (click)="emitSelect(c.id)"
                 (mouseenter)="onChatMouseEnter(c.id)"
                 (mouseleave)="onChatMouseLeave()">
              <span class="items-row__text">{{ c.title }}</span>
              <div class="chat-options-container">
                <button class="chat-options-btn" 
                        [class.visible]="hoveredChatId() === c.id"
                        (click)="onChatOptionsClick($event, c.id)"
                        [attr.aria-label]="'Opciones del chat ' + c.title">
                  <i class="pi pi-ellipsis-h"></i>
                </button>
              </div>
            </div>
          }
        </div>
      </div>
    }
  </div>

  <div class="sidebar-footer">
    <div class="sidebar-divider"></div>

    <div class="items-row has-icon" [class.active]="activeId === 'profile'" (click)="emitSelect('profile')">
      <div class="items-row__icon">
        <div class="avatar-fallback">{{ userInitials() }}</div>
      </div>
      @if (isOpen()) {
        <div class="items-row__text user-info">
          <span class="user-email">{{ userName() }}</span>
          <span class="user-meta">{{ userRol() }}</span>
        </div>
      }
    </div>
  </div>

</nav>

<!-- MenÃº de opciones de chat - Fuera del sidebar para evitar overflow -->
@if (showChatMenu()) {
  <div class="chat-menu-overlay" (click)="onCloseChatMenu()"></div>
  
  <div class="chat-options-menu-fixed"
       [style.left.px]="menuPosition().x"
       [style.top.px]="menuPosition().y">
    <div class="chat-menu-list">
      <button class="chat-menu-item" (click)="onChatActionSelected({chatId: showChatMenu()!, action: 'share'})">
        <i class="pi pi-share-alt chat-menu-icon"></i>
        <span class="chat-menu-label">Compartir</span>
      </button>
      <button class="chat-menu-item" (click)="onChatActionSelected({chatId: showChatMenu()!, action: 'rename'})">
        <i class="pi pi-pencil chat-menu-icon"></i>
        <span class="chat-menu-label">Cambiar el nombre</span>
      </button>
      <button class="chat-menu-item" (click)="onChatActionSelected({chatId: showChatMenu()!, action: 'archive'})">
        <i class="pi pi-inbox chat-menu-icon"></i>
        <span class="chat-menu-label">Archivar</span>
      </button>
      <button class="chat-menu-item danger" (click)="onChatActionSelected({chatId: showChatMenu()!, action: 'delete'})">
        <i class="pi pi-trash chat-menu-icon"></i>
        <span class="chat-menu-label">Eliminar</span>
      </button>
    </div>
  </div>
}
